From 0fa1ff9dabe423e343fe19377f4046a6fab99a9a Mon Sep 17 00:00:00 2001
From: bbcallen <bbcallen@gmail.com>
Date: Sun, 1 Jul 2012 18:44:58 +0800
Subject: [PATCH 02/25] core: define event for total buffering

---
 include/vlc/libvlc_events.h |    8 +++++++-
 include/vlc_input.h         |    3 +++
 lib/media_player.c          |    7 +++++++
 src/input/event.c           |   10 ++++++++++
 src/input/var.c             |    3 +++
 5 个文件被修改，插入 30 行(+)，删除 1 行(-)

diff --git a/include/vlc/libvlc_events.h b/include/vlc/libvlc_events.h
index 2cfedbf..d286cb4 100644
--- a/include/vlc/libvlc_events.h
+++ b/include/vlc/libvlc_events.h
@@ -100,7 +100,9 @@ enum libvlc_event_e {
     libvlc_VlmMediaInstanceStatusPlaying,
     libvlc_VlmMediaInstanceStatusPause,
     libvlc_VlmMediaInstanceStatusEnd,
-    libvlc_VlmMediaInstanceStatusError
+    libvlc_VlmMediaInstanceStatusError,
+
+    libvlc_MediaPlayerBufferingTotal=0x700,
 };
 
 /**
@@ -167,6 +169,10 @@ typedef struct libvlc_event_t
         {
             int new_count;
         } media_player_vout;
+        struct
+        {
+            float new_cache_total;
+        } media_player_buffering_total;
 
         /* media list */
         struct
diff --git a/include/vlc_input.h b/include/vlc_input.h
index 7d8320a..40ec3a8 100644
--- a/include/vlc_input.h
+++ b/include/vlc_input.h
@@ -437,6 +437,9 @@ typedef enum input_event_type_e
     /* A vout_thread_t object has been created/deleted by *the input* */
     INPUT_EVENT_VOUT,
 
+    /* "cache-total" has changed */
+    INPUT_EVENT_CACHE_TOTAL,
+
 } input_event_type_e;
 
 /**
diff --git a/lib/media_player.c b/lib/media_player.c
index b426637..a2d3be4 100644
--- a/lib/media_player.c
+++ b/lib/media_player.c
@@ -315,6 +315,13 @@ input_event_changed( vlc_object_t * p_this, char const * psz_cmd,
             var_GetFloat( p_input, "cache" ));
         libvlc_event_send( p_mi->p_event_manager, &event );
     }
+    else if( newval.i_int == INPUT_EVENT_CACHE_TOTAL )
+    {
+        event.type = libvlc_MediaPlayerBufferingTotal;
+        event.u.media_player_buffering_total.new_cache_total = (int)(100 *
+                                                         var_GetFloat( p_input, "cache-total" ));
+        libvlc_event_send( p_mi->p_event_manager, &event );
+    }
     else if( newval.i_int == INPUT_EVENT_VOUT )
     {
         vout_thread_t **pp_vout;
diff --git a/src/input/event.c b/src/input/event.c
index 453e04b..dec628e 100644
--- a/src/input/event.c
+++ b/src/input/event.c
@@ -195,6 +195,16 @@ void input_SendEventCache( input_thread_t *p_input, double f_level )
     Trigger( p_input, INPUT_EVENT_CACHE );
 }
 
+void input_SendEventTotal( input_thread_t *p_input, double f_level )
+{
+    vlc_value_t val;
+    
+    val.f_float = f_level;
+    var_Change( p_input, "cache-total", VLC_VAR_SETVALUE, &val, NULL );
+    
+    Trigger( p_input, INPUT_EVENT_CACHE_TOTAL );
+}
+
 /* FIXME: review them because vlc_event_send might be
  * moved inside input_item* functions.
  */
diff --git a/src/input/var.c b/src/input/var.c
index 9613fe2..198e0f9 100644
--- a/src/input/var.c
+++ b/src/input/var.c
@@ -501,6 +501,9 @@ void input_ConfigVarInit ( input_thread_t *p_input )
     var_Create( p_input, "cache", VLC_VAR_FLOAT );
     var_SetFloat( p_input, "cache", 0.0 );
 
+    var_Create( p_input, "cache-total", VLC_VAR_FLOAT );
+    var_SetFloat( p_input, "cache-total", 0.0 );
+
     /* */
     var_Create( p_input, "input-record-native", VLC_VAR_BOOL | VLC_VAR_DOINHERIT );
 
-- 
1.7.10.4

