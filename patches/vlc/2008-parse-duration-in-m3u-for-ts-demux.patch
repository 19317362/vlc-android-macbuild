From f27dd71bbaef2b2d31bd7461fdf7a53fceef60f8 Mon Sep 17 00:00:00 2001
From: bbcallen <bbcallen@gmail.com>
Date: Tue, 27 Mar 2012 23:11:58 +0800
Subject: [PATCH 2008/2009] parse duration in m3u for ts demux

---
 modules/demux/ts.c               |   11 +++++++++++
 modules/stream_filter/httplive.c |   14 ++++++++++++++
 2 files changed, 25 insertions(+)

diff --git a/modules/demux/ts.c b/modules/demux/ts.c
index f9c2f4d..fa9fd26 100644
--- a/modules/demux/ts.c
+++ b/modules/demux/ts.c
@@ -328,6 +328,9 @@ struct demux_sys_t
 
     /* */
     bool        b_start_record;
+
+    /* */
+    mtime_t     i_httplive_total_duration;  /* total duration parsed from m3u */
 };
 
 static int Demux    ( demux_t *p_demux );
@@ -706,6 +709,9 @@ static int Open( vlc_object_t *p_this )
             break;
     }
 
+    /* obtain total duration parsed from m3u file */
+    p_sys->i_httplive_total_duration = var_InheritInteger( p_demux->s, "httplive-total-duration" );
+
     return VLC_SUCCESS;
 }
 
@@ -1008,6 +1014,11 @@ static int Control( demux_t *p_demux, int i_query, va_list args )
             {
                 *pi64 = 0;
             }
+
+            if( *pi64 == 0 && p_sys->i_httplive_total_duration > 0 )
+            {
+                *pi64 = p_sys->i_httplive_total_duration;
+            }
         }
         else
         {
diff --git a/modules/stream_filter/httplive.c b/modules/stream_filter/httplive.c
index a8dfc4b..cecce50 100644
--- a/modules/stream_filter/httplive.c
+++ b/modules/stream_filter/httplive.c
@@ -1047,6 +1047,7 @@ static int parse_M3U8(stream_t *s, vlc_array_t *streams, uint8_t *buffer, const
 
         /* */
         int segment_duration = -1;
+        int total_duration_secs = 0;
         do
         {
             /* Next line */
@@ -1056,7 +1057,14 @@ static int parse_M3U8(stream_t *s, vlc_array_t *streams, uint8_t *buffer, const
             p_begin = p_read;
 
             if (strncmp(line, "#EXTINF", 7) == 0)
+            {
+                segment_duration = 0;
                 err = parse_SegmentInformation(hls, line, &segment_duration);
+                if (err == VLC_SUCCESS && segment_duration > 0)
+                {
+                    total_duration_secs += segment_duration;
+                }
+            }
             else if (strncmp(line, "#EXT-X-TARGETDURATION", 21) == 0)
                 err = parse_TargetDuration(s, hls, line);
             else if (strncmp(line, "#EXT-X-MEDIA-SEQUENCE", 21) == 0)
@@ -1087,6 +1095,12 @@ static int parse_M3U8(stream_t *s, vlc_array_t *streams, uint8_t *buffer, const
 
         } while (err == VLC_SUCCESS);
 
+        if (err == VLC_SUCCESS && total_duration_secs > 0)
+        {
+            var_Create(s, "httplive-total-duration", VLC_VAR_INTEGER);
+            var_SetInteger(s, "httplive-total-duration", ((int64_t)total_duration_secs) * 1000 * 1000);
+        }
+
         free(line);
     }
 
-- 
1.7.9.4

