From 145e86e941ae62d041b2e32fa2e9a5f8113ff7fe Mon Sep 17 00:00:00 2001
From: Zhang Rui <bbcallen@gmail.com>
Date: Sun, 4 Jan 2015 15:15:26 +0800
Subject: [PATCH 23/25] MediaCodec: check exception before release buffer

---
 modules/codec/omxil/android_mediacodec.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/modules/codec/omxil/android_mediacodec.c b/modules/codec/omxil/android_mediacodec.c
index ef2478f..c6096b2 100644
--- a/modules/codec/omxil/android_mediacodec.c
+++ b/modules/codec/omxil/android_mediacodec.c
@@ -686,6 +686,10 @@ static void DisplayBuffer(picture_sys_t* p_picsys, bool b_render)
     /* Release the MediaCodec buffer. */
     JNIEnv *env = NULL;
     jni_attach_thread(&env, THREAD_NAME);
+    if ((*env)->ExceptionOccurred(env)) {
+        msg_Err(p_dec, "Exception before MediaCodec.releaseOutputBuffer (DisplayBuffer)");
+        (*env)->ExceptionClear(env);
+    }
     (*env)->CallVoidMethod(env, p_sys->codec, p_sys->release_output_buffer, i_index, b_render);
     if ((*env)->ExceptionOccurred(env)) {
         msg_Err(p_dec, "Exception in MediaCodec.releaseOutputBuffer (DisplayBuffer)");
-- 
2.0.0

